{
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": "",
    "profile": "dev",
    "aws_region": "",
    "name": "",
    "instance_type": "",
    "environment": "",
    "email": ""
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "region": "{{ user `aws_region` }}",
      "source_ami_filter": {
        "filters": {
          "virtualization-type": "hvm",
          "name": "ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*",
          "root-device-type": "ebs"
        },
        "owners": [
          "099720109477"
        ],
        "most_recent": true
      },
      "instance_type": "t2.micro",
      "force_deregister": "true",
      "force_delete_snapshot": "true",
      "ssh_username": "ubuntu",
      "ami_name": "{{ user `name` }}-{{ user `environment` }}-{{ user `php_version` }}-{{ isotime | clean_ami_name }}",
      "tags": {
        "Name": "{{ user `name` }}-{{ user `environment` }}"
      }
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "ansible/files/",
      "destination": "/tmp"
    },
    {
      "type": "shell",
      "environment_vars": [
        "ENV={{ user `environment` }}",
        "EMAIL={{ user `email` }}"
      ],
      "inline": [
        "sleep 30",
        "sudo apt-get install -y wget",
        "sudo apt-add-repository -y ppa:brightbox/ruby-ng",
        "sudo apt-add-repository ppa:ansible/ansible",
        "sudo apt-get update -y",
        "sudo apt install -y software-properties-common",
        "sudo apt install -y ruby2.5",
        "sudo apt install -y awscli",
        "sudo apt install -y ansible",
        "cd /home/ubuntu",
        "wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install",
        "chmod +x ./install",
        "sudo ./install auto",
        "sudo service codedeploy-agent start",
        "sudo chmod +x /tmp/aliases-*",
        "cd /tmp",
        "sudo mv /tmp/ec2-configure.sh /tmp/php-configure.sh",
        "sudo ./aliases-$ENV.sh"
      ]
    },
    {
      "type": "ansible-local",
      "playbook_file": "./ansible/playbook.yml",
      "extra_arguments": [
         "--extra-vars",
         "ENV={{ user `environment` }}",
         "--extra-vars",
         "EMAIL={{ user `email` }}",
         "--extra-vars",
         "EFS={{ user `efs` }}",
         "--extra-vars",
         "SIGNALFX={{ user `signalfx` }}"
        ] 
    }
  ]
}