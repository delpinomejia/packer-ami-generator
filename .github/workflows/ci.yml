# ğŸš€ Production-Ready AWS AMI Builder - GitHub Actions Pipeline
# This workflow validates, estimates costs, and builds AWS AMIs using Packer

name: ğŸ¯ AMI Builder CI/CD

# Trigger workflow on push to master branch or pull requests
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allow manual triggering

env:
  AWS_REGION: us-east-1
  PACKER_VERSION: '1.9.4'

jobs:
  # ğŸ” Validation Stage - Check template syntax and configuration
  validate:
    name: ğŸ” Validate Template
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ› ï¸ Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
    
    - name: ğŸ”§ Initialize Packer Plugins
      run: |
        echo "ğŸ”§ Initializing Packer plugins..."
        packer init packer.pkr.hcl
        echo "âœ… Packer plugins initialized!"
    
    - name: âœ… Validate Packer Template
      run: |
        echo "ğŸ” Validating Packer template..."
        packer validate -var-file="variables.pkrvars.hcl" packer.pkr.hcl
        echo "âœ… Template validation successful!"
    
    - name: ğŸ“‹ Template Inspection
      run: |
        echo "ğŸ“‹ Inspecting template configuration..."
        packer inspect packer.pkr.hcl

  # ğŸ’° Cost Estimation Stage - Calculate build costs
  cost-estimate:
    name: ğŸ’° Cost Estimation
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ“Š Calculate Build Costs
      run: |
        echo "ğŸ’° Calculating estimated build costs..."
        
        # Extract instance type from variables file
        INSTANCE_TYPE=$(grep 'instance_type' variables.pkrvars.hcl | cut -d'"' -f2)
        echo "ğŸ“¦ Instance Type: $INSTANCE_TYPE"
        
        # Cost calculation (basic estimation)
        case $INSTANCE_TYPE in
          "t3.nano")   COST_PER_HOUR=0.0052 ;;
          "t3.micro")  COST_PER_HOUR=0.0104 ;;
          "t3.small")  COST_PER_HOUR=0.0208 ;;
          "t3.medium") COST_PER_HOUR=0.0416 ;;
          *) COST_PER_HOUR=0.0208 ;;  # Default to t3.small
        esac
        
        # Estimate 25-minute build time
        BUILD_DURATION_HOURS=$(echo "scale=4; 25/60" | bc -l)
        ESTIMATED_COST=$(echo "scale=2; $COST_PER_HOUR * $BUILD_DURATION_HOURS" | bc -l)
        
        echo "ğŸ’µ ESTIMATED BUILD COST BREAKDOWN"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“¦ Instance: $INSTANCE_TYPE @ \$$COST_PER_HOUR/hour"
        echo "â±ï¸  Duration: ~25 minutes"
        echo "ğŸ’¾ Storage: ~\$0.01 (temporary)"
        echo "ğŸŒ Data Transfer: Minimal"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ’° TOTAL ESTIMATED COST: ~\$$ESTIMATED_COST"
        
        # Save cost estimate for artifacts
        echo "ESTIMATED_COST=$ESTIMATED_COST" >> cost_estimate.env
        echo "INSTANCE_TYPE=$INSTANCE_TYPE" >> cost_estimate.env
    
    - name: ğŸ“ Upload Cost Estimate
      uses: actions/upload-artifact@v4
      with:
        name: cost-estimate
        path: cost_estimate.env
        retention-days: 30

  # ğŸ’° Cost Approval Stage - Manual review of estimated costs
  cost-approval:
    name: ğŸ’° Cost Approval
    runs-on: ubuntu-latest
    needs: [validate, cost-estimate]
    environment: cost-review  # Requires manual approval for costs
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ“ Download Cost Estimate
      uses: actions/download-artifact@v4
      with:
        name: cost-estimate
    
    - name: ğŸ’° Display Cost Estimate for Approval
      run: |
        echo "ğŸ’° COST ESTIMATE REVIEW"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        if [ -f cost_estimate.env ]; then
          source cost_estimate.env
          echo "ğŸ’µ Estimated Build Cost: $ESTIMATED_COST"
          echo "ğŸ“¦ Instance Type: $INSTANCE_TYPE"
          echo "â±ï¸  Estimated Duration: ~25 minutes"
          echo "ğŸŒ Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "âš ï¸  MANUAL APPROVAL REQUIRED"
          echo "Please review the cost estimate above."
          echo "If acceptable, approve this workflow to proceed with the AMI build."
          echo "Otherwise, cancel this workflow to avoid charges."
        else
          echo "âŒ Cost estimate file not found!"
          exit 1
        fi

  # ğŸ—ï¸ Build Stage - Create AMI (after cost approval)
  build:
    name: ğŸ—ï¸ Build AMI
    runs-on: ubuntu-latest
    needs: [validate, cost-estimate, cost-approval]
    environment: production  # Additional approval for production build
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ“ Download Cost Estimate
      uses: actions/download-artifact@v4
      with:
        name: cost-estimate
    
    - name: ğŸ“Š Display Build Information
      run: |
        echo "ğŸ—ï¸ Starting AMI build process..."
        if [ -f cost_estimate.env ]; then
          source cost_estimate.env
          echo "ğŸ’° Estimated build cost: \$$ESTIMATED_COST"
          echo "ğŸ“¦ Instance type: $INSTANCE_TYPE"
        fi
    
    - name: ğŸ› ï¸ Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
    
    - name: ğŸ”§ Initialize Packer Plugins
      run: |
        echo "ğŸ”§ Initializing Packer plugins..."
        packer init packer.pkr.hcl
        echo "âœ… Packer plugins initialized!"
    
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ—ï¸ Build AMI with Packer
      run: |
        echo "ğŸš€ Building AMI..."
        packer build -var-file="variables.pkrvars.hcl" packer.pkr.hcl
        echo "âœ… AMI build completed successfully!"
    
    - name: ğŸ“‹ Capture Build Artifacts
      run: |
        echo "ğŸ“‹ Capturing build information..."
        # Extract AMI ID from Packer output (if available in logs)
        echo "BUILD_TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> build_info.env
        echo "BUILD_STATUS=success" >> build_info.env
    
    - name: ğŸ“ Upload Build Information
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build_info.env
        retention-days: 90

  # ğŸ” Verification Stage - Verify AMI availability
  verify:
    name: ğŸ” Verify AMI
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ“ Download Build Information
      uses: actions/download-artifact@v4
      with:
        name: build-info
    
    - name: âœ… Verify AMI Availability
      run: |
        echo "ğŸ” Verifying AMI availability..."
        
        # Get AMI name prefix from variables
        AMI_PREFIX=$(grep 'ami_name_prefix' variables.pkrvars.hcl | cut -d'"' -f2)
        echo "ğŸ” Searching for AMIs with prefix: $AMI_PREFIX"
        
        # List recent AMIs
        aws ec2 describe-images \
          --owners self \
          --filters "Name=name,Values=${AMI_PREFIX}*" \
          --query 'Images[*].{Name:Name,ImageId:ImageId,State:State,CreationDate:CreationDate}' \
          --output table
        
        echo "âœ… AMI verification completed!"

  # ğŸ“Š Report Stage - Generate comprehensive build report
  report:
    name: ğŸ“Š Build Report
    runs-on: ubuntu-latest
    needs: [validate, cost-estimate, cost-approval, build, verify]
    if: always()  # Run even if previous jobs fail
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ“ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: ğŸ“Š Generate Build Report
      run: |
        echo "ğŸ“Š Generating comprehensive build report..."
        
        REPORT_FILE="build-report-$(date +%Y%m%d-%H%M%S).md"
        
        cat > "$REPORT_FILE" << EOF
        # ğŸ¯ AMI Build Report
        
        **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        **Repository:** ${{ github.repository }}
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        **Workflow:** ${{ github.run_id }}
        
        ## ğŸ“‹ Build Summary
        
        | Stage | Status |
        |-------|---------|
        | ğŸ” Validation | ${{ needs.validate.result }} |
        | ğŸ’° Cost Estimation | ${{ needs.cost-estimate.result }} |
        | ğŸ’° Cost Approval | ${{ needs.cost-approval.result }} |
        | ğŸ—ï¸ Build | ${{ needs.build.result }} |
        | âœ… Verification | ${{ needs.verify.result }} |
        
        ## ğŸ’° Cost Information
        EOF
        
        if [ -f artifacts/cost-estimate/cost_estimate.env ]; then
          # Safely read cost estimate variables
          ESTIMATED_COST=$(grep '^ESTIMATED_COST=' artifacts/cost-estimate/cost_estimate.env | cut -d'=' -f2 | tr -d '"')
          INSTANCE_TYPE=$(grep '^INSTANCE_TYPE=' artifacts/cost-estimate/cost_estimate.env | cut -d'=' -f2 | tr -d '"')
          echo "- **Estimated Cost:** \$$ESTIMATED_COST" >> "$REPORT_FILE"
          echo "- **Instance Type:** $INSTANCE_TYPE" >> "$REPORT_FILE"
        fi
        
        echo "" >> "$REPORT_FILE"
        echo "## ğŸ—ï¸ Build Details" >> "$REPORT_FILE"
        
        if [ -f artifacts/build-info/build_info.env ]; then
          # Safely read build info variables
          BUILD_STATUS=$(grep '^BUILD_STATUS=' artifacts/build-info/build_info.env | cut -d'=' -f2 | tr -d '"')
          BUILD_TIMESTAMP=$(grep '^BUILD_TIMESTAMP=' artifacts/build-info/build_info.env | cut -d'=' -f2 | tr -d '"')
          echo "- **Build Status:** $BUILD_STATUS" >> "$REPORT_FILE"
          echo "- **Build Completed:** $BUILD_TIMESTAMP" >> "$REPORT_FILE"
        fi
        
        echo "" >> "$REPORT_FILE"
        echo "---" >> "$REPORT_FILE"
        echo "*Generated by GitHub Actions - AWS AMI Builder Pipeline*" >> "$REPORT_FILE"
        
        echo "ğŸ“‹ Build report generated: $REPORT_FILE"
        cat "$REPORT_FILE"
    
    - name: ğŸ“ Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report-*.md
        retention-days: 365
