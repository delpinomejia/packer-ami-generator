name: 🚀 Packer AMI Builder

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggers

env:
  PACKER_VERSION: "1.14.0"

jobs:
  validate:
    name: 🔍 Validate Packer Templates
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
        
    - name: 📋 Verify Packer Installation
      run: |
        echo "🔍 Packer version:"
        packer --version
        echo "📍 Packer location:"
        which packer
        
    - name: ✅ Validate Templates
      run: |
        echo "🔍 Validating Packer templates..."
        packer validate -var-file="variables.pkrvars.hcl" packer.pkr.hcl
        echo "✅ Template validation successful!"
        
    - name: 📊 Format Check
      run: |
        echo "🎨 Checking Packer template formatting..."
        packer fmt -check packer.pkr.hcl
        echo "✅ Templates are properly formatted!"

  build-dry-run:
    name: 🧪 Dry Run Build Test
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
        
    - name: 🧪 Dry Run Test
      run: |
        echo "🧪 Running dry-run validation..."
        echo "This would be equivalent to: packer build -var-file='variables.pkrvars.hcl' packer.pkr.hcl"
        echo "✅ Dry run test completed!"

  build-ami:
    name: 🏗️ Build AMI
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production  # Requires manual approval for production builds
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
        
    - name: ⚙️ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
        
    - name: 🏗️ Build AMI
      run: |
        echo "🚀 Starting AMI build..."
        echo "💰 Estimated cost: $0.12-$0.22"
        packer build -var-file="variables.pkrvars.hcl" packer.pkr.hcl
        echo "✅ AMI build completed successfully!"
        
    - name: 📊 Build Summary
      if: always()
      run: |
        echo "📊 Build Summary:"
        echo "- Template: packer.pkr.hcl"
        echo "- Variables: variables.pkrvars.hcl"
        echo "- Region: ${{ vars.AWS_REGION || 'us-east-1' }}"
        echo "- Workflow: ${{ github.workflow }}"
        echo "- Run ID: ${{ github.run_id }}"
