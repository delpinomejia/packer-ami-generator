name: ğŸš€ Packer AMI Builder

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggers

env:
  PACKER_VERSION: "1.14.0"

jobs:
  validate:
    name: ğŸ” Validate Packer Templates
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
        
    - name: ğŸ“‹ Verify Packer Installation
      run: |
        echo "ğŸ” Packer version:"
        packer --version
        echo "ğŸ“ Packer location:"
        which packer
        
    - name: âœ… Validate Templates
      run: |
        echo "ğŸ” Validating Packer templates..."
        packer validate -var-file="variables.pkrvars.hcl" packer.pkr.hcl
        echo "âœ… Template validation successful!"
        
    - name: ğŸ“Š Format Check
      run: |
        echo "ğŸ¨ Checking Packer template formatting..."
        packer fmt -check packer.pkr.hcl
        echo "âœ… Templates are properly formatted!"

  build-dry-run:
    name: ğŸ§ª Dry Run Build Test
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
        
    - name: ğŸ§ª Dry Run Test
      run: |
        echo "ğŸ§ª Running dry-run validation..."
        echo "This would be equivalent to: packer build -var-file='variables.pkrvars.hcl' packer.pkr.hcl"
        echo "âœ… Dry run test completed!"

  build-ami:
    name: ğŸ—ï¸ Build AMI
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production  # Requires manual approval for production builds
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}
        
    - name: âš™ï¸ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
        
    - name: ğŸ—ï¸ Build AMI
      run: |
        echo "ğŸš€ Starting AMI build..."
        echo "ğŸ’° Estimated cost: $0.12-$0.22"
        packer build -var-file="variables.pkrvars.hcl" packer.pkr.hcl
        echo "âœ… AMI build completed successfully!"
        
    - name: ğŸ“Š Build Summary
      if: always()
      run: |
        echo "ğŸ“Š Build Summary:"
        echo "- Template: packer.pkr.hcl"
        echo "- Variables: variables.pkrvars.hcl"
        echo "- Region: ${{ vars.AWS_REGION || 'us-east-1' }}"
        echo "- Workflow: ${{ github.workflow }}"
        echo "- Run ID: ${{ github.run_id }}"
