{
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": ""
  },
  "builders": [
    {
      "type": "docker",
      "image": "ubuntu:18.04",
      "commit": "true",
      "pull": "true",
      "changes": [
        "WORKDIR /var/www/html",
        "CMD [\"nginx\", \"-g\", \"daemon off;\"]",
        "EXPOSE 80"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "ansible/files/",
      "destination": "/tmp"
    },
    {
      "type": "shell",
      "environment_vars": [
        "ENV={{ user `environment` }}",
        "EMAIL={{ user `email` }}"
      ],
      "inline": [
        "sleep 30",
        "apt-get update -y",
        "DEBIAN_FRONTEND=noninteractive apt install -y tzdata",
        "apt-get install software-properties-common -y",
        "apt-add-repository -y ppa:brightbox/ruby-ng",
        "apt-add-repository ppa:ansible/ansible",
        "apt-get update -y",
        "apt install apt-utils -y",
        "apt install -y wget",
        "apt install -y bc",
        "apt install -y cron",
        "apt install -y curl",
        "apt install -y dos2unix",
        "apt install -y fonts-tomsontalks",
        "apt install -y gcc",
        "apt install -y git",
        "apt install -y graphicsmagick",
        "apt install -y incron",
        "apt install -y jq",
        "apt install -y libgraphicsmagick1-dev",
        "apt install -y libmcrypt4",
        "apt install -y libpcre3-dev",
        "apt install -y libmcrypt-dev",
        "apt install -y libreadline-dev",
        "apt install -y libssl-dev",
        "apt install -y make",
        "apt install -y netcat",
        "apt install nfs-common -y",
        "apt install ntp -y",   
        "apt install -y openssh-server",
        "apt install -y redis-tools",    
        "apt install -y ruby2.5",
        "apt install -y sl",
        "apt install -y sqlite3",
        "apt install -y ssh",
        "apt install -y strace",
        "apt install -y awscli",
        "apt install -y ansible",
        "cd /tmp",
        "mv /tmp/docker-configure.sh /tmp/php-configure.sh",
        "wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install",
        "chmod +x ./install",
        "./install auto",
        "service codedeploy-agent start"
      ]
    },
    {
      "type": "ansible-local",
      "playbook_file": "./ansible/playbook.yml",
      "extra_arguments": [
        "--extra-vars",
        "ENV={{ user `environment` }}",
        "--extra-vars",
        "EMAIL={{ user `email` }}",
        "--extra-vars"
       ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "{{user `ecr_repository`}}",
        "tag": "{{user `tag`}}"
      },
      {
        "type": "docker-push",
        "ecr_login": "true",
        "login_username": "{{user `login_user`}}",
        "login_password": "{{user `login_password`}}",
        "login_server": "{{user `login_server`}}"
      },
      {
        "type": "docker-tag",
        "repository": "{{user `repository`}}",
        "tag": "{{user `tag`}}"
      },
      {
        "type": "docker-push",
        "login": "true",
        "login_username": "{{user `login_user`}}",
        "login_password": "{{user `login_password`}}"
      }
    ]
  ]
}
